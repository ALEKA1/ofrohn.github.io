// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,a){var n=e(t.map(function(t){return t*L}),a);return n.map(function(t){return t/L})}function e(t,e){var a,n,r,i,o,l,s,c,d,f,p=1e-5;return e?(l=t[0],0>l&&(l+=O),s=t[1],l-=e[0],i=e[1],o=e[2],a=Math.sin(s)*Math.sin(i)-Math.cos(s)*Math.cos(i)*Math.cos(l),Math.abs(a)<p&&(a=-Math.cos(s+i)+Math.cos(s)*Math.cos(i)*(1-Math.cos(l))),n=-Math.cos(s)*Math.sin(l),c=0!==a||0!==n?Math.atan2(n,a):l-Math.PI,d=o+c,d>Math.PI&&(d-=O),l%Math.PI===0?(f=s+Math.cos(l)*i,f>H&&(f=Math.PI-f),-H>f&&(f=-Math.PI-f)):(r=Math.sin(s)*Math.cos(i)+Math.cos(s)*Math.sin(i)*Math.cos(l),Math.abs(r)>.99?(f=Math.abs(Math.acos(Math.sqrt(a*a+n*n))),0>r&&(f*=-1)):f=Math.asin(r)),[d,f]):t}function a(t,e){var a=t.getUTCFullYear(),n=t.getUTCMonth()+1,r=t.getUTCDate(),i=t.getUTCHours(),o=t.getUTCMinutes(),l=t.getUTCSeconds();(1==n||2==n)&&(a-=1,n+=12);var s=Math.floor(a/100),c=2-s+Math.floor(s/4),d=Math.floor(365.25*a),f=Math.floor(30.6001*(n+1)),p=c+d+f-730550.5+r+(i+o/60+l/3600)/24,u=p/36525,h=280.46061837+360.98564736629*p+387933e-9*u*u-u*u*u/3871e4+e;if(h>0)for(;h>360;)h-=360;else for(;0>h;)h+=360;return h}function n(e,a){return t(e,G[a])}function r(t,e){if("equatorial"===e)return t;for(var a=G[e],n=t.features,r=0;r<n.length;r++)n[r].geometry.coordinates=i(n[r],a);return t}function i(e,a){var n=[];switch(e.geometry.type){case"Point":n=t(e.geometry.coordinates,a);break;case"LineString":n.push(o(e.geometry.coordinates,a));break;case"MultiLineString":n=l(e.geometry.coordinates,a);break;case"Polygon":n.push(o(e.geometry.coordinates[0],a));break;case"MultiPolygon":n.push(l(e.geometry.coordinates[0],a))}return n}function o(e,a){for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],a));return n}function l(t,e){for(var a=[],n=0;n<t.length;n++)a.push(o(t[n],e));return a}function s(t){return document.getElementById(t)}function c(t){return t+"px"}function d(t){return 10>t?"0"+t:t}function f(t,e){return null!==t&&hasOwnProperty.call(t,e)}function p(t){return!isNaN(parseFloat(t))&&isFinite(t)}function u(t){var e=0,a=0;if(t.offsetParent)do e+=t.offsetLeft,a+=t.offsetTop;while(null!==(t=t.offsetParent));return[e,a]}function h(t,e){for(;t.parentNode;){if(t.id===e)return!0;t=t.parentNode}return!1}function m(t,e,a){var n,r;switch(n=e.valueOf()-t.valueOf(),r=a||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return Math.floor(n)}function g(t){function e(){var e=this;if(e){switch(e.id){case"width":if(w(e)===!1)return;t.width=e.value;break;case"projection":t.projection=e.options[e.selectedIndex].value;break;case"transform":var a=t.transform;t.transform=e.options[e.selectedIndex].value;var n=s("centerx");n&&(M(t.transform,a),t.center[0]=n.value)}D.display(t)}}function a(){w(this)!==!1&&n()!==!1&&D.rotate(t)}function n(){var e=s("centerx"),a=s("centery"),n=s("centerz");if(e&&a){if("equatorial"!==t.transform)t.center[0]=parseFloat(e.value);else{var r=parseFloat(e.value);t.center[0]=r>12?15*r-360:15*r}t.center[1]=parseFloat(a.value);var i=parseFloat(n.value);return t.center[2]=isNaN(i)?0:i,""!==e.value&&""!==a.value}}function r(){var e,a=this;switch(a.type){case"checkbox":e=a.checked,v(a);break;case"number":if(w(a)===!1)return;e=parseFloat(a.value);break;case"color":if(k(a)===!1)return;e=a.value;break;case"text":if(-1===a.id.search(/fill$/))return;if(k(a)===!1)return;e=a.value}null!==e&&(i(a.id,e),n(),D.apply(t))}function i(e,a){var n=e.split("-");switch(n.length){case 1:t[n[0]]=a;break;case 2:t[n[0]][n[1]]=a;break;case 3:t[n[0]][n[1]][n[2]]=a;break;default:return}}var o=D.projections(),l=D.eulerAngles(),c=d3.select("#celestial-form").append("div").attr("class","ctrl"),d=c.append("form").attr("id","params").attr("name","params").attr("method","get").attr("action","#"),f=d.append("div").attr("class","col");f.append("label").attr("title","Map width, 0 indicates full width").attr("for","width").html("Width "),f.append("input").attr("type","number").attr("maxlength","4").attr("max","9999").attr("min","0").attr("title","Map width").attr("id","width").attr("value",t.width).on("change",e),f.append("span").html("px"),f.append("label").attr("title","Map projection, (hemi) indicates hemispherical projection").attr("for","projection").html("Projection");var p=f.append("select").attr("id","projection").on("change",e),u=0,h=Object.keys(o).map(function(e,a){var n=o[e].clip&&o[e].clip===!0?o[e].n+" (hemi)":o[e].n;return e===t.projection&&(u=a),{o:e,n:n}});p.selectAll("option").data(h).enter().append("option").attr("value",function(t){return t.o}).text(function(t){return t.n}),p.property("selectedIndex",u),u=0,f.append("label").attr("title","Coordinate space in which the map is displayed").attr("for","transform").html("Coordinates"),p=f.append("select").attr("id","transform").on("change",e),h=Object.keys(l).map(function(e,a){return e===t.transform&&(u=a),{o:e,n:e.replace(/^([a-z])/,function(t,e){return e.toUpperCase()})}}),p.selectAll("option").data(h).enter().append("option").attr("value",function(t){return t.o}).text(function(t){return t.n}),p.property("selectedIndex",u),f.append("br"),f.append("label").attr("title","Center coordinates long/lat in selected coordinate space").attr("for","centerx").html("Center"),f.append("input").attr("type","number").attr("id","centerx").attr("title","Center right ascension/longitude").attr("max","24").attr("min","0").attr("step","0.1").on("change",a),f.append("span").attr("id","cxunit").html("h"),f.append("input").attr("type","number").attr("id","centery").attr("title","Center declination/latitude").attr("max","90").attr("min","-90").attr("step","0.1").on("change",a),f.append("span").html("°"),f.append("label").attr("title","Orientation").attr("for","centerz").html("Orientation"),f.append("input").attr("type","number").attr("id","centerz").attr("title","Center orientation").attr("max","180").attr("min","-180").attr("step","0.1").on("change",a),f.append("span").html("°"),f.append("label").attr("for","orientationfixed").html("Fixed"),f.append("input").attr("type","checkbox").attr("id","orientationfixed").property("checked",t.orientationfixed).on("change",r),t.fullwidth&&f.append("input").attr("type","button").attr("id","fullwidth").attr("value","◄ Full Width ►").on("click",function(){return s("sidebar-wrapper").style.display="none",s("outer-wrapper").style.width="100%",s("main-wrapper").style.width="100%",this.style.display="none",D.display(t),!1}),x(t.center,t.transform),f=d.append("div").attr("class","col"),f.append("label").attr("class","header").attr("for","stars-show").html("Stars"),f.append("input").attr("type","checkbox").attr("id","stars-show").property("checked",t.stars.show).on("change",r),f.append("label").attr("for","stars-limit").html("down to magnitude"),f.append("input").attr("type","number").attr("id","stars-limit").attr("title","Star display limit").attr("value",t.stars.limit).attr("max","6").attr("min","-1").attr("step","0.1").on("change",r),f.append("label").attr("for","stars-colors").html("with spectral colors"),f.append("input").attr("type","checkbox").attr("id","stars-colors").property("checked",t.stars.colors).on("change",r),f.append("label").attr("for","stars-color").html("or default color "),f.append("input").attr("type","color").attr("autocomplete","off").attr("id","stars-style-fill").attr("title","Star color").property("value",t.stars.style.fill).on("change",r),f.append("br"),f.append("label").attr("for","stars-names").html("Show names"),f.append("input").attr("type","checkbox").attr("id","stars-names").property("checked",t.stars.names).on("change",r),f.append("label").attr("for","stars-proper").html("proper names (if any)"),f.append("input").attr("type","checkbox").attr("id","stars-proper").property("checked",t.stars.proper).on("change",r),f.append("label").attr("for","stars-desig").attr("title","include HD/HIP designations").html("all designations"),f.append("input").attr("type","checkbox").attr("id","stars-desig").property("checked",t.stars.desig).on("change",r),f.append("label").attr("for","stars-namelimit").html("down to mag"),f.append("input").attr("type","number").attr("id","stars-namelimit").attr("title","Star name display limit").attr("value",t.stars.namelimit).attr("max","6").attr("min","-1").attr("step","0.1").on("change",r),v(s("stars-show")),f=d.append("div").attr("class","col"),f.append("label").attr("class","header").attr("title","Deep Space Objects").attr("for","dsos-show").html("DSOs"),f.append("input").attr("type","checkbox").attr("id","dsos-show").property("checked",t.dsos.show).on("change",r),f.append("label").attr("for","dsos-limit").html("down to mag"),f.append("input").attr("type","number").attr("id","dsos-limit").attr("title","DSO display limit").attr("value",t.dsos.limit).attr("max","6").attr("min","0").attr("step","0.1").on("change",r),f.append("label").attr("for","dsos-names").html("with names"),f.append("input").attr("type","checkbox").attr("id","dsos-names").property("checked",t.dsos.names).on("change",r),f.append("label").attr("for","dsos-desig").html("or designations"),f.append("input").attr("type","checkbox").attr("id","dsos-desig").property("checked",t.dsos.desig).on("change",r),f.append("label").attr("for","dsos-namelimit").html("down to mag"),f.append("input").attr("type","number").attr("id","dsos-namelimit").attr("title","DSO name display limit").attr("value",t.dsos.namelimit).attr("max","6").attr("min","0").attr("step","0.1").on("change",r),v(s("dsos-show")),f=d.append("div").attr("class","col"),f.append("label").attr("class","header").html("Constellations"),f.append("label").attr("for","constellations-names").html("Show names"),f.append("input").attr("type","checkbox").attr("id","constellations-names").property("checked",t.constellations.names).on("change",r),f.append("label").attr("for","constellations-desig").html("abbreviated"),f.append("input").attr("type","checkbox").attr("id","constellations-desig").property("checked",t.constellations.desig).on("change",r),f.append("label").attr("for","constellations-lines").html("with lines"),f.append("input").attr("type","checkbox").attr("id","constellations-lines").property("checked",t.constellations.lines).on("change",r),f.append("label").attr("for","constellations-bounds").html("with boundaries"),f.append("input").attr("type","checkbox").attr("id","constellations-bounds").property("checked",t.constellations.bounds).on("change",r),v(s("constellations-names")),f=d.append("div").attr("class","col"),f.append("label").attr("class","header").html("Lines"),f.append("label").attr("title","X/Y grid lines").attr("for","lines-graticule").html("Graticule"),f.append("input").attr("type","checkbox").attr("id","lines-graticule-show").property("checked",t.lines.graticule.show).on("change",r),f.append("label").attr("for","lines-equatorial").html("Equator"),f.append("input").attr("type","checkbox").attr("id","lines-equatorial-show").property("checked",t.lines.equatorial.show).on("change",r),f.append("label").attr("for","lines-ecliptic").html("Ecliptic"),f.append("input").attr("type","checkbox").attr("id","lines-ecliptic-show").property("checked",t.lines.ecliptic.show).on("change",r),f.append("label").attr("for","lines-galactic").html("Galactic plane"),f.append("input").attr("type","checkbox").attr("id","lines-galactic-show").property("checked",t.lines.galactic.show).on("change",r),f.append("label").attr("for","lines-supergalactic").html("Supergalactic plane"),f.append("input").attr("type","checkbox").attr("id","lines-supergalactic-show").property("checked",t.lines.supergalactic.show).on("change",r),f=d.append("div").attr("class","col"),f.append("label").attr("class","header").html("Other"),f.append("label").attr("for","mw-show").html("Milky Way"),f.append("input").attr("type","checkbox").attr("id","mw-show").property("checked",t.mw.show).on("change",r),f.append("label").attr("for","background").html("Background color"),f.append("input").attr("type","color").attr("id","background-fill").attr("title","Background color").attr("value",t.background.fill).on("change",r),f.append("label").attr("title","Star/DSO sizes are increased with higher zoom-levels").attr("for","adaptable").html("Adaptable sizes"),f.append("input").attr("type","checkbox").attr("id","adaptable").property("checked",t.adaptable).on("change",r),z(),M(t.transform)}function v(t){var e,a=t.id;switch(a){case"stars-show":e=!s(a).checked;for(var n=0;n<U[a].length;n++)y(U[a][n],e);case"stars-names":for(e=!s("stars-names").checked||!s("stars-show").checked,n=0;n<U["stars-names"].length;n++)y(U["stars-names"][n],e);break;case"dsos-show":for(e=!s(a).checked,n=0;n<U[a].length;n++)y(U[a][n],e);case"dsos-names":for(e=!s("dsos-names").checked||!s("dsos-show").checked,n=0;n<U["dsos-names"].length;n++)y(U["dsos-names"][n],e);break;case"constellations-show":for(e=!s(a).checked,n=0;n<U[a].length;n++)y(U[a][n],e)}}function y(t,e){var a=s(t);a.disabled=e,a.previousSibling.style.color=e?"#999":"#000"}function b(t,e){var a=u(t);d3.select("#error").html(e).style({top:c(a[1]+t.offsetHeight+1),left:c(a[0]),opacity:1}),t.focus()}function w(t){var e,a="hr"===t.id||"min"===t.id||"sec"===t.id?1:0;if(t.validity){if(e=t.validity,e.typeMismatch||e.badInput)return b(t,t.title+": check field value"),!1;if(e.rangeOverflow||e.rangeUnderflow)return b(t,t.title+" must be between "+(parseInt(t.min)+a)+" and "+(parseInt(t.max)-a)),!1}else{if(e=t.value,!p(e))return b(t,t.title+": check field value"),!1;if(e=parseFloat(e),e<t.min||e>t.max)return b(t,t.title+" must be between "+(t.min+a)+" and "+(+t.max-a)),!1}return d3.select("#error").style({top:"-9999px",left:"-9999px",opacity:0}),!0}function k(t){if(t.validity){if(e=t.validity,e.typeMismatch||e.badInput)return b(t,t.title+": check field value"),!1;if(-1===t.value.search(/^#[0-9A-F]{6}$/i))return b(t,t.title+": not a color value"),!1}else{var e=t.value;if(""===e)return!0;if(-1===e.search(/^#[0-9A-F]{6}$/i))return b(t,t.title+": not a color value"),!1}return d3.select("#error").style({top:"-9999px",left:"-9999px",opacity:0}),!0}function M(t,e){var a=s("centerx");a&&(e&&("equatorial"===t&&"equatorial"!==e?(a.value=(a.value/15).toFixed(1),a.value<0&&(a.value+=24)):"equatorial"!==t&&"equatorial"===e&&(a.value=(15*a.value).toFixed(1),a.value>180&&(a.value-=360))),"equatorial"===t?(a.min="0",a.max="24",s("cxunit").innerHTML="h"):(a.min="-180",a.max="180",s("cxunit").innerHTML="°"))}function x(t,e){var a=s("centerx"),n=s("centery"),r=s("centerz");a&&n&&(null===t&&(t=[0,0,0]),t.length<=2&&(t[2]=0),a.value="equatorial"!==e?t[0].toFixed(1):t[0]<0?(t[0]/15+24).toFixed(1):(t[0]/15).toFixed(1),n.value=t[1].toFixed(1),r.value=null!==t[2]?t[2].toFixed(1):0)}function z(){var t,e,a,n=/\d+(\.\d+)?/g,r={s:6,d:6},i=D.settings();return a=i.dsos.data,t=a.match(n),null!==t&&(r.d=parseFloat(t[t.length-1])),6!=r.d&&(s("dsos-limit").max=r.d,s("dsos-namelimit").max=r.d),e=i.stars.data,t=e.match(n),null!==t&&(r.s=parseFloat(t[t.length-1])),6!=r.s&&(s("stars-limit").max=r.s,s("stars-namelimit").max=r.s),r}function I(t){function e(){l.setTime(Date.now()),s("datetime").value=r(l,p),i()}function a(){navigator.geolocation.getCurrentPosition(function(t){c=[t.coords.latitude.toFixed(4),t.coords.longitude.toFixed(4)],d3.select("#lat").attr("value",c[0]),d3.select("#lon").attr("value",c[1]),i()})}function n(){u.show(l)}function r(t,e){var a;if(e&&"0"!==e){var n=Math.floor(Math.abs(e)/60),r=Math.abs(e)-60*n,i=0>e?" +":" −";a=i+d(n)+d(r)}else a=" ±0000";return f(t)+a}function i(){var e=s("lon").value,a=s("lat").value,n=!!s("horizon-show").checked;l=f.parse(s("datetime").value.slice(0,-6));var r=l.getTimezoneOffset(),i=new Date(l.valueOf()+6e4*(p-r));t.horizon.show=n,""!==e&&""!==a&&(c=[parseFloat(a),parseFloat(e)],Y=D.getPoint(_.inverse(i,[90,0],c),t.transform),Y[2]=0,D.rotate({center:Y,horizon:t.horizon}))}var o=d3.select("#celestial-form").append("div").attr("id","loc"),l=new Date,c=[0,0],f=d3.time.format("%Y-%m-%d %H:%M:%S"),p=l.getTimezoneOffset(),u=new R(function(t,e){s("datetime").value=r(t,e),p=e,i()}),m=o.append("div").attr("class","col");m.append("label").attr("title","Location coordinates long/lat").attr("for","lat").html("Location"),m.append("input").attr("type","number").attr("id","lat").attr("title","Latitude").attr("placeholder","Latitude").attr("max","90").attr("min","-90").attr("step","0.0001").attr("value",c[0]).on("change",function(){w(this)===!0&&i()}),m.append("span").html("°"),m.append("input").attr("type","number").attr("id","lon").attr("title","Longitude").attr("placeholder","Longitude").attr("max","180").attr("min","-180").attr("step","0.0001").attr("value",c[1]).on("change",function(){w(this)===!0&&i()}),m.append("span").html("°"),"geolocation"in navigator&&m.append("input").attr("type","button").attr("value","Here").attr("id","here").on("click",a),m.append("label").attr("title","Local date/time").attr("for","datetime").html(" Date/time"),m.append("input").attr("type","text").attr("id","datetime").attr("title","Date and time").attr("value",r(l,p)).on("click",n,!0).on("input",function(){this.value=r(l,p),u.isVisible()||n()}),m.append("div").attr("id","datepick").on("click",n),m.append("input").attr("type","button").attr("value","Now").attr("id","now").on("click",e),m.append("br"),m.append("label").attr("title","Show horizon marker").attr("for","horizon-show").html(" Horizon marker"),m.append("input").attr("type","checkbox").attr("id","horizon-show").property("checked",t.horizon.show).on("change",i),d3.select(document).on("mousedown",function(){!h(d3.event.target,"celestial-date")&&u.isVisible()&&u.hide()}),setTimeout(i,1e3)}var P,T,q,A,j,S,F,D={version:"0.5.5",container:null,data:[]};D.display=function(e){function a(t){var e=T.scale()*t,a=A.scaleExtent();e<a[0]&&(e=a[0]),e>a[1]&&(e=a[1]),T.scale([e]),A.scale([e]),l()}function n(t){P=P.set(t),l()}function i(t){P=P.set(t);var e=T.rotate();ot=U(P.center),(""===ot[2]||void 0===ot[2])&&(ot[2]=e[2]),T.rotate(ot),l()}function o(){if(!(P.width&&P.width>0)){tt=_(),et=tt/Z;var t=Q.scale*tt/1024;st.attr("width",tt).attr("height",et),A.scale([t]),T.translate([tt/2,et/2]).scale([t]),q.translate([tt/2,et/2]),$&&($.style.height=c(et)),l()}}function l(){var t=T.rotate();q.scale(T.scale()),P.adaptable&&(it=Math.sqrt(T.scale()/at)),P.orientationfixed&&(t[2]=P.center[2],T.rotate(t)),nt=P.stars.size*it,P.center=[-t[0],-t[1],t[2]],x(P.center,P.transform),L(),p(P.background),R.selectAll(".outline").attr("d",S),ct.fill(),P.mw.show&&R.selectAll(".mw").each(function(t){p(P.mw.style),j(t),ct.fill()});for(var e in P.lines)f(P.lines,e)&&P.lines[e].show===!0&&(p(P.lines[e]),R.selectAll("."+e).attr("d",j),ct.stroke());P.constellations.show&&(P.constellations.names&&(u(P.constellations.namestyle),R.selectAll(".constname").each(function(t){if(d(t.geometry.coordinates)){var e=T(t.geometry.coordinates);ct.fillText(O(t),e[0],e[1])}})),P.constellations.lines&&R.selectAll(".constline").each(function(t){p(P.constellations.linestyle),j(t),ct.stroke()}),P.constellations.bounds&&R.selectAll(".boundaryline").each(function(t){p(P.constellations.boundstyle),j(t),ct.stroke()})),P.stars.show&&(p(P.stars.style),R.selectAll(".star").each(function(t){if(d(t.geometry.coordinates)&&t.properties.mag<=P.stars.limit){var e=T(t.geometry.coordinates),a=M(t);ct.fillStyle=z(t),ct.beginPath(),ct.arc(e[0],e[1],a,0,2*Math.PI),ct.closePath(),ct.fill(),P.stars.names&&t.properties.mag<=P.stars.namelimit*it&&(u(P.stars.namestyle),ct.fillText(k(t),e[0]+a,e[1]+a))}})),P.dsos.show&&R.selectAll(".dso").each(function(t){if(d(t.geometry.coordinates)&&m(t.properties,P.dsos.limit)){var e=T(t.geometry.coordinates),a=t.properties.type;p(P.dsos.symbols[a]);var n=v(t,e);f(P.dsos.symbols[a],"stroke")?ct.stroke():ct.fill(),P.dsos.names&&m(t.properties,P.dsos.namelimit)&&(u(P.dsos.namestyle),ct.fillStyle=P.dsos.symbols[a].fill,ct.fillText(w(t),e[0]+n,e[1]+n))}}),D.data.length>0&&D.data.forEach(function(t){t.redraw()}),p(P.background),R.selectAll(".outline").attr("d",S),ct.stroke(),P.location&&P.horizon.show&&!Q.clip&&(F.origin(D.nadir()),p(P.horizon),R.selectAll(".horizon").datum(F).attr("d",j),ct.fill()),P.controls&&h(T.scale())}function d(t){return Q.clip&&d3.geo.distance(P.center,t)>H?0:1}function p(t){ct.fillStyle=t.fill||null,ct.strokeStyle=t.stroke||null,ct.lineWidth=t.width||null,ct.globalAlpha=t.opacity||1,ct.font=t.font,ct.setLineDash(f(t,"dash")?t.dash:[]),ct.beginPath()}function u(t){ct.fillStyle=t.fill,ct.textAlign=t.align||"left",ct.textBaseline=t.baseline||"bottom",ct.globalAlpha=t.opacity||1,ct.font=t.font}function h(t){var e=s("celestial-zoomin"),a=s("celestial-zoomout");e&&a&&(e.disabled=t>=4.99*at,a.disabled=at>=t)}function m(t,e){return 999===t.mag&&Math.sqrt(parseInt(t.dim))>e||999!==t.mag&&t.mag<=e}function v(t,e){var a=t.properties,n=b(a)||9,r=y(a.type);return B.symbol().type(r).size(n).position(e)(ct),Math.sqrt(n)/2}function y(t){return t&&f(P.dsos.symbols,t)?P.dsos.symbols[t].shape:"circle"}function b(t){return t.mag&&999!=t.mag?Math.pow(2*nt-t.mag,1.4):Math.pow(parseInt(t.dim)*nt/7,.5)}function w(t){var e=t.properties;if(""!==e.name)return P.dsos.desig&&e.desig?e.desig:e.name}function k(t){var e=t.properties.desig;return P.stars.proper&&""!==t.properties.name&&(e=t.properties.name),P.stars.desig?e:e.replace(/^H(D|IP).+/,"")}function M(t){var e=t.properties.mag;if(null===e)return.1;var a=nt*Math.exp(rt*(e+2));return Math.max(a,.1)}function z(t){var e=t.properties.bv;return!P.stars.colors||isNaN(e)?P.stars.style.fill:V(e)}function O(t){return P.constellations.desig?t.properties.desig:t.properties.name}function L(){ct.clearRect(0,0,tt+K[0],et+K[1])}function _(){return P.width&&P.width>0?P.width:$?$.clientWidth-K[0]:window.innerWidth-2*K[0]}function U(t){if(null===t)return[0,0,0];var e=C.equatorial;return[e[0]-t[0],e[1]-t[1],e[2]+t[2]]}var Y,R=D.container;P=N.set(e),P.stars.size=P.stars.size||7,P.center=P.center||[0,0];var $=s(P.container);if($){Y="#"+P.container;var J=window.getComputedStyle($,null);parseInt(J.width)||P.width||($.style.width=c($.parentNode.clientWidth))}else Y="body",$=null;if(f(W,P.projection)){var Q=W[P.projection],X=P.transform||"equatorial",Z=Q.ratio||2,K=[16,16],tt=_(),et=tt/Z,at=Q.scale*tt/1024,nt=P.stars.size,rt=-.28,it=1,ot=U(P.center),lt=P.datapath||"";lt=lt.replace(/([^\/]$)/,"$1/"),"body"!=Y&&(s(P.container).style.height=c(et)),T=D.projection(P.projection).rotate(ot).translate([tt/2,et/2]).scale([at]),q=D.projection(P.projection).translate([tt/2,et/2]).scale([at]),Q.clip&&T.clipAngle(90),F=d3.geo.circle().angle([90]),A=d3.geo.zoom().projection(T).center([tt/2,et/2]).scaleExtent([at,5*at]).on("zoom.redraw",l);var st=d3.selectAll("canvas");0===st[0].length&&(st=d3.select(Y).append("canvas")),st.attr("width",tt).attr("height",et);var ct=st.node().getContext("2d"),dt=d3.geo.graticule().minorStep([15,10]);j=d3.geo.path().projection(T).context(ct),S=d3.geo.path().projection(q).context(ct),R?R.selectAll("*").remove():R=d3.select(Y).append("container"),P.interactive?st.call(A):st.attr("style","cursor: default!important"),Q.clip?R.append("path").datum(F).attr("class","outline"):(R.append("path").datum(dt.outline).attr("class","outline"),P.location&&P.horizon.show&&R.append("path").datum(F).attr("class","horizon"));for(var ft in P.lines)f(P.lines,ft)&&("graticule"===ft?R.append("path").datum(dt).attr("class","graticule"):R.append("path").datum(d3.geo.circle().angle([90]).origin(t(E[ft],G[X]))).attr("class",ft));if(d3.json(lt+"mw.json",function(t,e){if(t)return window.alert("Your Browser doesn't support local file loading or the file doesn't exist. See readme.md"),console.warn(t);var a=r(e,X);R.selectAll(".mway").data(a.features).enter().append("path").attr("class","mw"),l()}),d3.json(lt+"constellations.json",function(t,e){if(t)return console.warn(t);var a=r(e,X);R.selectAll(".constnames").data(a.features).enter().append("text").attr("class","constname"),l()}),d3.json(lt+"constellations.bounds.json",function(t,e){if(t)return console.warn(t);var a=r(e,X);R.selectAll(".bounds").data(a.features).enter().append("path").attr("class","boundaryline"),l()}),d3.json(lt+"constellations.lines.json",function(t,e){if(t)return console.warn(t);var a=r(e,X);R.selectAll(".lines").data(a.features).enter().append("path").attr("class","constline"),l()}),d3.json(lt+P.stars.data,function(t,e){if(t)return console.warn(t);var a=r(e,X);R.selectAll(".stars").data(a.features).enter().append("path").attr("class","star"),l()}),d3.json(lt+P.dsos.data,function(t,e){if(t)return console.warn(t);var a=r(e,X);R.selectAll(".dsos").data(a.features).enter().append("path").attr("class","dso"),l()}),this.data.length>0&&this.data.forEach(function(t){f(t,"file")?d3.json(t.file,t.callback):setTimeout(t.callback,0)},this),d3.select(window).on("resize",o),P.controls===!0&&null===s("celestial-zoomin")&&(d3.select(Y).append("input").attr("type","button").attr("id","celestial-zoomin").attr("value","+").on("click",function(){a(1.111)}),d3.select(Y).append("input").attr("type","button").attr("id","celestial-zoomout").attr("value","−").on("click",function(){a(.9)})),P.location===!0){null===s("loc")?I(P):i({center:D.zenith()});var pt=s("horizon-show");pt&&(pt.style.display=Q.clip===!0?"none":"inline-block"),pt.previousSibling.style.display=pt.style.display}P.form===!0&&null===s("params")&&g(P),null===s("error")&&d3.select("body").append("div").attr("id","error"),this.container=R,this.clip=d,this.map=j,this.mapProjection=T,this.context=ct,this.setStyle=p,this.setTextStyle=u,this.redraw=l,this.resize=function(){o()},this.apply=function(t){n(t)},this.rotate=function(t){return t?void i(t):P.center},this.zoomBy=function(t){return t?void a(t):T.scale()}}},D.projection=function(t){var e,a,n;if(!f(W,t))throw new Error("Projection not supported: "+t);return e=W[t],a=null!==e.arg?d3.geo[t].raw(e.arg):d3.geo[t].raw,n=function(t,e){var n=a(-t,e);return n},n.invert=function(t,e){var n=a.invert(t,e);return n[0]*=-1,n},d3.geo.projection(n)};var C={equatorial:[0,0,0],ecliptic:[0,0,23.4393],galactic:[93.5949,28.9362,-58.5988],supergalactic:[137.31,59.5283,57.7303]},E={equatorial:[0,90],ecliptic:[-90,66.5607],galactic:[-167.1405,27.1283],supergalactic:[-76.2458,15.7089]};D.eulerAngles=function(){return C},D.poles=function(){return E};var O=2*Math.PI,H=Math.PI/2,L=Math.PI/180,G={ecliptic:[-90,23.4393,90],"inverse ecliptic":[90,23.4393,-90],galactic:[-167.1405,62.8717,122.9319],"inverse galactic":[122.9319,62.8717,-167.1405],supergalactic:[283.7542,74.2911,26.4504],"inverse supergalactic":[26.4504,74.2911,283.7542],init:function(){for(var t in this)this[t].constructor==Array&&(this[t]=this[t].map(function(t){return t*L}))},add:function(t,e){return e&&t&&3===e.length&&!this.hasOwnProperty(t)?(this[t]=e.map(function(t){return t*L}),this[t]):void 0}};G.init(),D.euler=function(){return G};var _=function(t,e,n){var r=a(t,n[1])-e[0];0>r&&(r+=360),r*=L;var i=e[1]*L,o=n[0]*L,l=Math.asin(Math.sin(i)*Math.sin(o)+Math.cos(i)*Math.cos(o)*Math.cos(r)),s=Math.acos((Math.sin(i)-Math.sin(l)*Math.sin(o))/(Math.cos(l)*Math.cos(o)));return Math.sin(r)>0&&(s=2*Math.PI-s),[l/L,s/L,0]};_.inverse=function(t,e,n){var r=e[0]*L,i=e[1]*L,o=n[0]*L,l=Math.asin(Math.sin(r)*Math.sin(o)+Math.cos(r)*Math.cos(o)*Math.cos(i)),s=((Math.sin(r)-Math.sin(l)*Math.sin(o))/(Math.cos(l)*Math.cos(o))).toFixed(6);s=Math.acos(s),s/=L;var c=a(t,n[1])-s;return[c,l/L,0]},D.horizontal=_,D.add=function(t){var e={};return f(t,"type")?"dso"!==t.type||f(t,"file")&&f(t,"callback")?"line"!==t.type||f(t,"callback")?(f(t,"file")&&(e.file=t.file),e.type=t.type,f(t,"callback")&&(e.callback=t.callback),f(t,"redraw")&&(e.redraw=t.redraw),void D.data.push(e)):console.log("Can't add line"):console.log("Can't add data file"):console.log("Missing type")},D.getData=r,D.getPoint=n;var N={width:0,projection:"aitoff",transform:"equatorial",center:null,orientationfixed:!0,background:{fill:"#000000",stroke:"#000000",opacity:1,width:1},adaptable:!0,interactive:!0,form:!1,location:!1,horizon:{show:!0,fill:"#000",opacity:.6},daylight:{show:!1,fill:"#fff",opacity:.4},fullwidth:!1,controls:!0,container:"celestial-map",datapath:"data/",stars:{show:!0,limit:6,colors:!0,style:{fill:"#ffffff",opacity:1},names:!0,proper:!1,desig:!1,namestyle:{fill:"#ddddbb",font:"11px Georgia, Times, 'Times Roman', serif",align:"left",baseline:"top"},namelimit:2.5,size:7,data:"stars.6.json"},dsos:{show:!0,limit:6,names:!0,desig:!0,namestyle:{fill:"#cccccc",font:"11px Helvetica, Arial, serif",align:"left",baseline:"top"},namelimit:4,data:"dsos.bright.json",symbols:{gg:{shape:"circle",fill:"#ff0000"},g:{shape:"ellipse",fill:"#ff0000"},s:{shape:"ellipse",fill:"#ff0000"},s0:{shape:"ellipse",fill:"#ff0000"},sd:{shape:"ellipse",fill:"#ff0000"},e:{shape:"ellipse",fill:"#ff0000"},i:{shape:"ellipse",fill:"#ff0000"},oc:{shape:"circle",fill:"#ff9900",stroke:"#ff9900",width:2},gc:{shape:"circle",fill:"#ff9900"},en:{shape:"square",fill:"#ff00cc"},bn:{shape:"square",fill:"#ff00cc"},sfr:{shape:"square",fill:"#cc00ff"},rn:{shape:"square",fill:"#00ooff"},pn:{shape:"diamond",fill:"#00cccc"},snr:{shape:"diamond",fill:"#ff00cc"},dn:{shape:"square",fill:"#999999",stroke:"#999999",width:2},pos:{shape:"marker",fill:"#cccccc",stroke:"#cccccc",width:1.5}}},constellations:{show:!0,names:!0,desig:!0,namestyle:{fill:"#cccc99",font:"12px Helvetica, Arial, sans-serif",align:"center",baseline:"middle",opacity:.8},lines:!0,linestyle:{stroke:"#cccccc",width:1.5,opacity:.6},bounds:!1,boundstyle:{stroke:"#ccff00",width:1,opacity:.8,dash:[2,4]}},mw:{show:!0,style:{fill:"#ffffff",opacity:"0.15"}},lines:{graticule:{show:!0,stroke:"#cccccc",width:.6,opacity:.8},equatorial:{show:!0,stroke:"#aaaaaa",width:1.3,opacity:.7},ecliptic:{show:!0,stroke:"#66cc66",width:1.3,opacity:.7},galactic:{show:!1,stroke:"#cc6666",width:1.3,opacity:.7},supergalactic:{show:!1,stroke:"#cc66cc",width:1.3,opacity:.7}},set:function(t){var e,a,n={};if(!t)return this;for(e in this)if(f(this,e))if(f(t,e)&&null!==t[e])if(null===this[e]||this[e].constructor!=Object)n[e]=t[e];else{n[e]={};for(a in this[e])n[e][a]=f(t[e],a)?t[e][a]:this[e][a]}else n[e]=this[e];return n}};D.settings=function(){return N};var V=d3.scale.quantize().domain([3.347,-.335]).range(["#ff4700","#ff4b00","#ff4f00","#ff5300","#ff5600","#ff5900","#ff5b00","#ff5d00","#ff6000","#ff6300","#ff6500","#ff6700","#ff6900","#ff6b00","#ff6d00","#ff7000","#ff7300","#ff7500","#ff7800","#ff7a00","#ff7c00","#ff7e00","#ff8100","#ff8300","#ff8506","#ff870a","#ff8912","#ff8b1a","#ff8e21","#ff9127","#ff932c","#ff9631","#ff9836","#ff9a3c","#ff9d3f","#ffa148","#ffa34b","#ffa54f","#ffa753","#ffa957","#ffab5a","#ffad5e","#ffb165","#ffb269","#ffb46b","#ffb872","#ffb975","#ffbb78","#ffbe7e","#ffc184","#ffc489","#ffc78f","#ffc892","#ffc994","#ffcc99","#ffce9f","#ffd1a3","#ffd3a8","#ffd5ad","#ffd7b1","#ffd9b6","#ffdbba","#ffddbe","#ffdfc2","#ffe1c6","#ffe3ca","#ffe4ce","#ffe8d5","#ffe9d9","#ffebdc","#ffece0","#ffefe6","#fff0e9","#fff2ec","#fff4f2","#fff5f5","#fff6f8","#fff9fd","#fef9ff","#f9f6ff","#f6f4ff","#f3f2ff","#eff0ff","#ebeeff","#e9edff","#e6ebff","#e3e9ff","#e0e7ff","#dee6ff","#dce5ff","#d9e3ff","#d7e2ff","#d3e0ff","#c9d9ff","#bfd3ff","#b7ceff","#afc9ff","#a9c5ff","#a4c2ff","#9fbfff","#9bbcff"]),W={airy:{n:"Airy’s Minimum Error",arg:Math.PI/2,scale:360,ratio:1,clip:!0},aitoff:{n:"Aitoff",arg:null,scale:162},armadillo:{n:"Armadillo",arg:0,scale:250},august:{n:"August",arg:null,scale:94,ratio:1.4},azimuthalEqualArea:{n:"Azimuthal Equal Area",arg:null,scale:340,ratio:1,clip:!0},azimuthalEquidistant:{n:"Azimuthal Equidistant",arg:null,scale:320,ratio:1,clip:!0},baker:{n:"Baker Dinomic",arg:null,scale:160,ratio:1.4},berghaus:{n:"Berghaus Star",arg:0,scale:320,ratio:1,clip:!0},boggs:{n:"Boggs Eumorphic",arg:null,scale:170},bonne:{n:"Bonne",arg:Math.PI/5,scale:225,ratio:.88},bromley:{n:"Bromley",arg:null,scale:162},collignon:{n:"Collignon",arg:null,scale:100,ratio:2.6},craig:{n:"Craig Retroazimuthal",arg:-.1,scale:310,ratio:1.5,clip:!0},craster:{n:"Craster Parabolic",arg:null,scale:160},cylindricalEqualArea:{
n:"Cylindrical Equal Area",arg:Math.PI/6,scale:190,ratio:2.3},cylindricalStereographic:{n:"Cylindrical Stereographic",arg:Math.PI/4,scale:230,ratio:1.3},eckert1:{n:"Eckert I",arg:null,scale:175},eckert2:{n:"Eckert II",arg:null,scale:175},eckert3:{n:"Eckert III",arg:null,scale:190},eckert4:{n:"Eckert IV",arg:null,scale:190},eckert5:{n:"Eckert V",arg:null,scale:182},eckert6:{n:"Eckert VI",arg:null,scale:182},eisenlohr:{n:"Eisenlohr",arg:null,scale:102},equirectangular:{n:"Equirectangular",arg:null,scale:165},fahey:{n:"Fahey",arg:null,scale:196,ratio:1.4},mtFlatPolarParabolic:{n:"Flat Polar Parabolic",arg:null,scale:175},mtFlatPolarQuartic:{n:"Flat Polar Quartic",arg:null,scale:230,ratio:1.65},mtFlatPolarSinusoidal:{n:"Flat Polar Sinusoidal",arg:null,scale:175,ratio:1.9},foucaut:{n:"Foucaut",arg:null,scale:142},ginzburg4:{n:"Ginzburg IV",arg:null,scale:180,ratio:1.7},ginzburg5:{n:"Ginzburg V",arg:null,scale:196,ratio:1.55},ginzburg6:{n:"Ginzburg VI",arg:null,scale:190,ratio:1.4},ginzburg8:{n:"Ginzburg VIII",arg:null,scale:205,ratio:1.3},ginzburg9:{n:"Ginzburg IX",arg:null,scale:190,ratio:1.4},homolosine:{n:"Goode Homolosine",arg:null,scale:160,ratio:2.2},hammer:{n:"Hammer",arg:2,scale:180},hatano:{n:"Hatano",arg:null,scale:186},healpix:{n:"HEALPix",arg:1,scale:320,ratio:1.2},hill:{n:"Hill Eucyclic",arg:2,scale:190,ratio:1.1},kavrayskiy7:{n:"Kavrayskiy VII",arg:null,scale:185,ratio:1.75},lagrange:{n:"Lagrange",arg:Math.PI/4,scale:88,ratio:1.6,clip:!1},larrivee:{n:"l'Arrivée",arg:null,scale:160,ratio:1.25},laskowski:{n:"Laskowski Tri-Optimal",arg:null,scale:165,ratio:1.7},loximuthal:{n:"Loximuthal",arg:Math.PI/4,scale:175,ratio:1.8},mercator:{n:"Mercator",arg:null,scale:160,ratio:1.3},miller:{n:"Miller",arg:null,scale:160,ratio:1.5},mollweide:{n:"Mollweide",arg:null,scale:180},naturalEarth:{n:"Natural Earth",arg:null,scale:185,ratio:1.85},nellHammer:{n:"Nell Hammer",arg:null,scale:160,ratio:2.6},orthographic:{n:"Orthographic",arg:null,scale:480,ratio:1,clip:!0},patterson:{n:"Patterson Cylindrical",arg:null,scale:160,ratio:1.75},polyconic:{n:"Polyconic",arg:null,scale:160,ratio:1.3},rectangularPolyconic:{n:"Rectangular Polyconic",arg:0,scale:160,ratio:1.65},robinson:{n:"Robinson",arg:null,scale:160},sinusoidal:{n:"Sinusoidal",arg:null,scale:160,ratio:2},stereographic:{n:"Stereographic",arg:null,scale:500,ratio:1,clip:!0},times:{n:"Times",arg:null,scale:210,ratio:1.4},twoPointEquidistant:{n:"Two-Point Equidistant",arg:Math.PI/2,scale:320,ratio:1.15,clip:!0},vanDerGrinten:{n:"van Der Grinten",arg:null,scale:160,ratio:1},vanDerGrinten2:{n:"van Der Grinten II",arg:null,scale:160,ratio:1},vanDerGrinten3:{n:"van Der Grinten III",arg:null,scale:160,ratio:1},vanDerGrinten4:{n:"van Der Grinten IV",arg:null,scale:160,ratio:1.6},wagner4:{n:"Wagner IV",arg:null,scale:185},wagner6:{n:"Wagner VI",arg:null,scale:160},wagner7:{n:"Wagner VII",arg:null,scale:190,ratio:1.8},wiechel:{n:"Wiechel",arg:null,scale:360,ratio:1,clip:!0},winkel3:{n:"Winkel Tripel",arg:null,scale:196,ratio:1.7}};D.projections=function(){return W};var B={};B.symbol=function(){function t(t){i[a()](t)}var e,a=d3.functor("circle"),n=d3.functor(64),r=(d3.functor("#fff"),d3.functor("")),i=(d3.functor([2,2]),{circle:function(t){var a=Math.sqrt(n()),r=a/2;return t.arc(e[0],e[1],r,0,2*Math.PI),r},square:function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0]-r,e[1]-r),t.lineTo(e[0]+r,e[1]-r),t.lineTo(e[0]+r,e[1]+r),t.lineTo(e[0]-r,e[1]+r),t.closePath(),r},diamond:function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-r),t.lineTo(e[0]+r,e[1]),t.lineTo(e[0],e[1]+r),t.lineTo(e[0]-r,e[1]),t.closePath(),r},triangle:function(t){var a=Math.sqrt(n()),r=a/Math.sqrt(3);return t.moveTo(e[0],e[1]-r),t.lineTo(e[0]+r,e[1]+r),t.lineTo(e[0]-r,e[1]+r),t.closePath(),r},ellipse:function(t){var a=Math.sqrt(n()),r=a/2;return t.save(),t.translate(e[0],e[1]),t.scale(1.6,.8),t.beginPath(),t.arc(0,0,r,0,2*Math.PI),t.closePath(),t.restore(),r},marker:function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-a),t.lineTo(e[0],e[1]+a),t.moveTo(e[0]-a,e[1]),t.lineTo(e[0]+a,e[1]),t.closePath(),r},"cross-circle":function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-a),t.lineTo(e[0],e[1]+a),t.moveTo(e[0]-a,e[1]),t.lineTo(e[0]+a,e[1]),t.stroke(),t.beginPath(),t.moveTo(e[0],e[1]),t.arc(e[0],e[1],r,0,2*Math.PI),t.closePath(),r},"stroke-circle":function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-a),t.lineTo(e[0],e[1]+a),t.stroke(),t.beginPath(),t.moveTo(e[0],e[1]),t.arc(e[0],e[1],r,0,2*Math.PI),t.closePath(),r}});return t.type=function(e){return arguments.length?(a=d3.functor(e),t):a},t.size=function(e){return arguments.length?(n=d3.functor(e),t):n},t.text=function(e){return arguments.length?(r=d3.functor(e),t):r},t.position=function(a){return arguments.length?(e=a,t):void 0},t},D.Canvas=B;var U={"stars-show":["stars-limit","stars-colors","stars-style-fill","stars-names"],"stars-names":["stars-proper","stars-desig","stars-namelimit"],"dsos-show":["dsos-limit","dsos-names"],"dsos-names":["dsos-desig","dsos-namelimit"],"constellations-names":["constellations-desig"]},Y=[0,0];D.zenith=function(){return Y},D.nadir=function(){var t=-Y[1],e=Y[0]+180;return e>180&&(e-=360),[e,t-.001]};var R=function(t){function e(){var t=s("mon").value,e=s("yr").value,a=new Date(e,t,1),n=d3.select("#cal"),r=new Date;e=parseInt(e),t=parseInt(t),a.setDate(a.getDate()-a.getDay());for(var i=n.node();i.firstChild;)i.removeChild(i.firstChild);for(var o=0;42>o;o++){var l=a.getMonth(),c=a.getDay(),d=b(a);n.append("div").classed({date:!0,grey:l!==t,weekend:l===t&&(0===c||6===c),today:0===m(a,r),selected:0===m(a,h)}).attr("id",d).on("click",u).html(a.getDate().toString()),a.setDate(a.getDate()+1)}}function a(){var t=k.append("select").attr("title","Year").attr("id","yr").on("change",e),a=0,n=h.getFullYear();t.selectAll("option").data(y).enter().append("option").text(function(t,e){return t===n&&(a=e),t.toString()}),t.property("selectedIndex",a)}function n(){var t=k.append("select").attr("title","Month").attr("id","mon").on("change",e),a=0,n=h.getMonth();t.selectAll("option").data(v).enter().append("option").attr("value",function(t,e){return e===n&&(a=e),e}).text(function(t){return t}),t.property("selectedIndex",a)}function r(t){k.append("div").attr("id",t).on("click",function(){var a=s("mon"),n=s("yr");"left"===t?0===a.selectedIndex?(a.selectedIndex=11,n.selectedIndex--):a.selectedIndex--:11===a.selectedIndex?(a.selectedIndex=0,n.selectedIndex++):a.selectedIndex++,e()})}function i(){k.append("input").attr("type","number").attr("id","hr").attr("title","Hours").attr("max","24").attr("min","-1").attr("step","1").attr("value",h.getHours()).on("change",function(){w(this)===!0&&u()}),k.append("input").attr("type","number").attr("id","min").attr("title","Minutes").attr("max","60").attr("min","-1").attr("step","1").attr("value",h.getMinutes()).on("change",function(){w(this)===!0&&u()}),k.append("input").attr("type","number").attr("id","sec").attr("title","Seconds").attr("max","60").attr("min","-1").attr("step","1").attr("value",h.getSeconds()).on("change",function(){w(this)===!0&&u()})}function o(){var t=k.append("select").attr("title","Time zone offset from UTC").attr("id","tz").on("change",u),e=15,a=h.getTimezoneOffset();t.selectAll("option").data(g).enter().append("option").attr("value",function(t,n){var r=Object.keys(t)[0];return t[r]===a&&(e=n),t[r]}).text(function(t){return Object.keys(t)[0]}),t.property("selectedIndex",e)}function l(t){for(var e=t.getFullYear(),a=[],n=e-10;e+10>=n;n++)a.push(n);return a}function d(t,e){for(var a=s(t),n=0;n<a.childNodes.length;n++)if(a.childNodes[n].value==e){a.selectedIndex=n;break}}function f(t){t&&h.setTime(t.valueOf()),d("yr",h.getFullYear()),d("mon",h.getMonth()),e(),s("hr").value=h.getHours(),s("min").value=h.getMinutes(),s("sec").value=h.getSeconds()}function p(){d3.select("#celestial-date").style("opacity",0),d3.select("#error").style({top:"-9999px",left:"-9999px",opacity:0}),d3.select("#datepick").classed("active",!1),setTimeout(function(){s("celestial-date").style.top=c(-9999)},600)}function u(){var e=s("hr").value,a=s("min").value,n=s("sec").value,r=s("tz").value;this.id&&-1!==this.id.search(/^\d/)&&(h=b.parse(this.id)),h.setHours(e,a,n),f(),t(h,r)}var h=new Date,g=(d3.time.format("%Z"),[{"−12:00":720},{"−11:00":660},{"−10:00":600},{"−09:30":570},{"−09:00":540},{"−08:00":480},{"−07:00":420},{"−06:00":360},{"−05:00":300},{"−04:30":270},{"−04:00":240},{"−03:30":210},{"−03:00":180},{"−02:00":120},{"−01:00":60},{"±00:00":0},{"+01:00":-60},{"+02:00":-120},{"+03:00":-180},{"+03:30":-210},{"+04:00":-240},{"+04:30":-270},{"+05:00":-300},{"+05:30":-330},{"+05:45":-345},{"+06:00":-360},{"+06:30":-390},{"+07:00":-420},{"+08:00":-480},{"+08:30":-510},{"+08:45":-525},{"+09:00":-540},{"+09:30":-570},{"+10:00":-600},{"+10:30":-630},{"+11:00":-660},{"+12:00":-720},{"+12:45":-765},{"+13:00":-780},{"+14:00":-840}]),v=["January","February","March","April","May","June","July","August","September","October","November","December"],y=l(h),b=d3.time.format("%Y-%m-%d"),k=d3.select("#celestial-form").append("div").attr("id","celestial-date");r("left"),n(),a(),r("right");k.append("div").attr("id","cal");e(),i(),o(),this.show=function(t){var e=s("celestial-date"),a=s("datepick"),n=a.offsetLeft+a.offsetWidth-e.offsetWidth,r=a.offsetTop-e.offsetHeight-1;-9999===e.offsetTop?(h.setTime(t.valueOf()),f(),d3.select("#celestial-date").style({top:c(r),left:c(n),opacity:1}),d3.select("#datepick").classed("active",!0)):p()},this.isVisible=function(){return-9999!==s("celestial-date").offsetTop},this.hide=function(){p()}};!function(){function t(t,e,a){var n=t.translate(),r=Math.atan2(e[1]-n[1],e[0]-n[0])-Math.atan2(a[1]-n[1],a[0]-n[0]);return[Math.cos(r/2),0,0,Math.sin(r/2)]}function e(t,e){var a=t.invert(e);return a&&isFinite(a[0])&&isFinite(a[1])&&l(a)}function a(t){var e=.5*t[0]*f,a=.5*t[1]*f,n=.5*t[2]*f,r=Math.sin(e),i=Math.cos(e),o=Math.sin(a),l=Math.cos(a),s=Math.sin(n),c=Math.cos(n);return[i*l*c+r*o*s,r*l*c-i*o*s,i*o*c+r*l*s,i*l*s-r*o*c]}function n(t,e){var a=t[0],n=t[1],r=t[2],i=t[3],o=e[0],l=e[1],s=e[2],c=e[3];return[a*o-n*l-r*s-i*c,a*l+n*o+r*c-i*s,a*s-n*c+r*o+i*l,a*c+n*s-r*l+i*o]}function r(t,e){if(t&&e){var a=c(t,e),n=Math.sqrt(s(a,a)),r=.5*Math.acos(Math.max(-1,Math.min(1,s(t,e)))),i=Math.sin(r)/n;return n&&[Math.cos(r),a[2]*i,-a[1]*i,a[0]*i]}}function i(t,e){var a=Math.max(-1,Math.min(1,s(t,e))),n=0>a?-1:1,r=Math.acos(n*a),i=Math.sin(r);return i?function(a){var o=n*Math.sin((1-a)*r)/i,l=Math.sin(a*r)/i;return[t[0]*o+e[0]*l,t[1]*o+e[1]*l,t[2]*o+e[2]*l,t[3]*o+e[3]*l]}:function(){return t}}function o(t){return[Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),1-2*(t[1]*t[1]+t[2]*t[2]))*p,Math.asin(Math.max(-1,Math.min(1,2*(t[0]*t[2]-t[3]*t[1]))))*p,Math.atan2(2*(t[0]*t[3]+t[1]*t[2]),1-2*(t[2]*t[2]+t[3]*t[3]))*p]}function l(t){var e=t[0]*f,a=t[1]*f,n=Math.cos(a);return[n*Math.cos(e),n*Math.sin(e),Math.sin(a)]}function s(t,e){for(var a=0,n=t.length,r=0;n>a;++a)r+=t[a]*e[a];return r}function c(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function d(t){for(var e=0,a=arguments.length,n=[];++e<a;)n.push(arguments[e]);var r=d3.dispatch.apply(null,n);return r.of=function(e,a){return function(n){try{var i=n.sourceEvent=d3.event;n.target=t,d3.event=n,r[n.type].apply(e,a)}finally{d3.event=i}}},r}var f=Math.PI/180,p=180/Math.PI;d3.geo.zoom=function(){function s(t){m++||t({type:"zoomstart"})}function c(t){t({type:"zoom"})}function f(t){--m||t({type:"zoomend"})}var p,u,h,m=0,g=d(v,"zoomstart","zoom","zoomend"),v=d3.behavior.zoom().on("zoomstart",function(){var i=d3.mouse(this),l=a(p.rotate()),d=e(p,i);d&&(h=d),y.call(v,"zoom",function(){p.scale(b.k=d3.event.scale);var a=d3.mouse(this),s=r(h,e(p,a));p.rotate(b.r=o(l=s?n(l,s):n(t(p,i,a),l))),i=a,c(g.of(this,arguments))}),s(g.of(this,arguments))}).on("zoomend",function(){y.call(v,"zoom",null),f(g.of(this,arguments))}),y=v.on,b={r:[0,0,0],k:1};return v.rotateTo=function(t){var e=r(l(t),l([-b.r[0],-b.r[1]]));return o(n(a(b.r),e))},v.projection=function(t){return arguments.length?(p=t,b={r:p.rotate(),k:p.scale()},v.scale(b.k)):p},v.duration=function(t){return arguments.length?(u=t,v):u},v.event=function(t){t.each(function(){var t=d3.select(this),e=g.of(this,arguments),n=b,r=d3.transition(t);if(r!==t){r.each("start.zoom",function(){this.__chart__&&(b=this.__chart__),p.rotate(b.r).scale(b.k),s(e)}).tween("zoom:zoom",function(){var t=v.size()[0],l=i(a(b.r),a(n.r)),s=d3.geo.distance(b.r,n.r),d=d3.interpolateZoom([0,0,t/b.k],[s,0,t/n.k]);return u&&r.duration(u(.001*d.duration)),function(a){var n=d(a);this.__chart__=b={r:o(l(n[0]/s)),k:t/n[2]},p.rotate(b.r).scale(b.k),v.scale(b.k),c(e)}}).each("end.zoom",function(){f(e)});try{r.each("interrupt.zoom",function(){f(e)})}catch(l){console.log(l)}}else this.__chart__=b,s(e),c(e),f(e)})},d3.rebind(v,g,"on")}}(),this.Celestial=D}();